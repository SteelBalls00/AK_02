from app.processors.base import BaseProcessor


class GPKFirstDistrictProcessor(BaseProcessor):
    """
    ГПК — 1 инстанция — районный / городской суд
    """

    COLUMN_TO_CATEGORY = {
        # 0 — Судья (специальный столбец, данных в pkl нет)
        "Судья": None,
        "Рассм. дел\nза неделю": "Рассмотрено за неделю",
        "Рассм. дел\nс начала года": "Рассмотрено с начала года",
        "Наруш. мотивир.\nв неделю": "Нарушение мотивировки в неделю",
        "Наруш. мотивир.\nс начала года": "Нарушений изготовления мотивировки с начала года",
        "Принято\nза неделю": "Принято за неделю",
        "Принято\nс начала года": "Принято с начала года",
        "Поступило\nза неделю": "Передано за неделю",
        "Поступило\nс начала года": "Передано с начала года",
        "Остаток": "Остаток",
        "Без движения\nсейчас (за год)": "Без движения за год",
        "Без движения\nв неделе": "Без движения в этой неделе",
        "Приостановлено\nдел": "Приостановлено дел",
        "От 2 до 6 мес.": "От 2 до 6 месяцев",
        "От 6 месяцев\nдо 1 года": "От 6 месяцев до 1 года",
        "От 1 года\nдо 2 лет": "От 1 года до 2 лет",
        "Свыше двух\nлет": "Свыше двух лет",
        "Не сдано в канц.\nсвыше срока": "Не сдано в канц. свыше срока",
        "Нарушений сдачи\nв канц. с нач. года": "Нарушений сдачи в канц. с нач. года",
    }

    COLUMN_TO_INCLUDED_CATEGORY = {
        "От 2 до 6 мес.": "От 2 до 6 месяцев (рассмотренные в текущем году)",
        "От 6 месяцев\nдо 1 года": "От 6 месяцев до 1 года (рассмотренные в текущем году)",
        "От 1 года\nдо 2 лет": "От 1 года до 2 лет (рассмотренные в текущем году)",
        "Свыше двух\nлет": "Свыше двух лет (рассмотренные в текущем году)",
    }

    def __init__(self):
        # порядок колонок = порядок значений в строке
        self.columns = [
            "Судья",
            "Рассм. дел\nза неделю",
            "Рассм. дел\nс начала года",
            "Наруш. мотивир.\nв неделю",
            "Наруш. мотивир.\nс начала года",
            "Принято\nза неделю",
            "Принято\nс начала года",
            "Поступило\nза неделю",
            "Поступило\nс начала года",
            "Остаток",
            "Без движения\nсейчас (за год)",
            "Без движения\nв неделе",
            "Приостановлено\nдел",
            "От 2 до 6 мес.",
            "От 6 месяцев\nдо 1 года",
            "От 1 года\nдо 2 лет",
            "Свыше двух\nлет",
            "Не сдано в канц.\nсвыше срока",
            "Нарушений\nсдачи в канц.\nс нач. года",
        ]

        # категории, которые реально лежат в pkl
        self.categories = [
            "Рассмотрено за неделю",
            "Рассмотрено с начала года",
            "Нарушение мотивировки в неделю",
            "Нарушений изготовления мотивировки с начала года",
            "Принято за неделю",
            "Принято с начала года",
            "Передано за неделю",
            "Передано с начала года",
            "Остаток",
            "Без движения",
            "Без движения за год",
            "Без движения в этой неделе",
            "Приостановлено дел",
            "От 2 до 6 месяцев",
            "От 2 до 6 месяцев (рассмотренные в текущем году)",
            "От 6 месяцев до 1 года",
            "От 6 месяцев до 1 года (рассмотренные в текущем году)",
            "От 1 года до 2 лет",
            "От 1 года до 2 лет (рассмотренные в текущем году)",
            "Свыше двух лет",
            "Свыше двух лет (рассмотренные в текущем году)",
            "Не сдано в канц. свыше срока",
            "Нарушений сдачи в канц. с нач. года",
        ]

    # ---------- public ----------

    def build(self, raw_data, week_index):
        self.raw_data = raw_data
        self.week_index = week_index
        weeks = list(raw_data.keys())
        week_key = weeks[week_index]
        week_data = raw_data[week_key]

        totals = self._init_counter()
        rows = []

        for judge, judge_data in week_data.items():
            row, totals = self._process_judge(judge, judge_data, totals)
            rows.append(row)

        return {
            "week": week_key,
            "columns": self.columns,
            "rows": rows,
            "total": self._build_total_row(totals),
            "tooltips": [
                "",
                "Количество рассмотренных\nдел за отчётную неделю",
                "Количество рассмотренных\nдел с начала календарного года",
                "Количество дел с нарушением срока\nизготовления мотивированного\nрешения за неделю",
                "Количество дел с нарушением срока\nизготовления мотивированного\nрешения с начала года",
                "Количество дел, принятых\nк производству за неделю",
                "Количество дел, принятых\nк производству с начала года",
                "Количество дел, переданных\nсудье за неделю",
                "Количество дел, переданных\nсудье с начала года",
                "Остаток дел на конец\nотчётной недели",
                "Всего дел, оставленных без движения:\nна конец недели (с начала года)",
                "Дела,\nоставленные без движения\nтолько в этой неделе",
                "Количество приостановленных дел",
                "Дела со сроком рассмотрения от 2 до 6 месяцев:\nкол-во таких дел на конец недели\n(кол-во таких дел, рассмотренных с 01 января по текущую неделю)",
                "Дела со сроком рассмотрения от 6 месяцев до 1 года:\nкол-во дел на конец недели\n(кол-во таких дел, рассмотренных с 01 января по текущую неделю)",
                "Дела со сроком рассмотрения т 1 года до 2 лет:\nкол-во дел на конец недели\n(кол-во таких дел, рассмотренных с 01 января по текущую неделю)",
                "Дела со сроком рассмотрения свыше 2 лет:\nкол-во дел на конец недели\n(кол-во таких дел, рассмотренных с 01 января по текущую неделю)",
                "Количество дел, не сданных в канцелярию\nсвыше установленного срока\nв этой неделе",
                "Количество нарушений сроков\nсдачи дел в канцелярию\nс начала года",
            ],
        }

    # ---------- helpers ----------

    def _init_counter(self):
        return {name: 0 for name in self.categories}

    def _process_judge(self, judge, judge_data, totals):
        values = self._init_counter()

        for category, cases in judge_data.items():
            if category in values:
                count = len(cases)
                values[category] = count
                totals[category] += count

        return self._format_row(judge, values), totals

    def _format_row(self, j, v):
        return [
            j,
            v["Рассмотрено за неделю"],
            v["Рассмотрено с начала года"],
            v["Нарушение мотивировки в неделю"],
            v["Нарушений изготовления мотивировки с начала года"],
            v["Принято за неделю"],
            v["Принято с начала года"],
            v["Передано за неделю"],
            v["Передано с начала года"],
            v["Остаток"],
            f'{v["Без движения"]} ({v["Без движения за год"]})',
            v["Без движения в этой неделе"],
            v["Приостановлено дел"],
            f'{v["От 2 до 6 месяцев"]} ({v["От 2 до 6 месяцев (рассмотренные в текущем году)"]})',
            f'{v["От 6 месяцев до 1 года"]} ({v["От 6 месяцев до 1 года (рассмотренные в текущем году)"]})',
            f'{v["От 1 года до 2 лет"]} ({v["От 1 года до 2 лет (рассмотренные в текущем году)"]})',
            f'{v["Свыше двух лет"]} ({v["Свыше двух лет (рассмотренные в текущем году)"]})',
            v["Не сдано в канц. свыше срока"],
            v["Нарушений сдачи в канц. с нач. года"],
        ]

    def _build_total_row(self, t):
        return [
            "Всего",
            t["Рассмотрено за неделю"],
            t["Рассмотрено с начала года"],
            t["Нарушение мотивировки в неделю"],
            t["Нарушений изготовления мотивировки с начала года"],
            t["Принято за неделю"],
            t["Принято с начала года"],
            t["Передано за неделю"],
            t["Передано с начала года"],
            t["Остаток"],
            f'{t["Без движения"]} ({t["Без движения за год"]})',
            t["Без движения в этой неделе"],
            t["Приостановлено дел"],
            f'{t["От 2 до 6 месяцев"]} ({t["От 2 до 6 месяцев (рассмотренные в текущем году)"]})',
            f'{t["От 6 месяцев до 1 года"]} ({t["От 6 месяцев до 1 года (рассмотренные в текущем году)"]})',
            f'{t["От 1 года до 2 лет"]} ({t["От 1 года до 2 лет (рассмотренные в текущем году)"]})',
            f'{t["Свыше двух лет"]} ({t["Свыше двух лет (рассмотренные в текущем году)"]})',
            t["Не сдано в канц. свыше срока"],
            t["Нарушений сдачи в канц. с нач. года"],
        ]
